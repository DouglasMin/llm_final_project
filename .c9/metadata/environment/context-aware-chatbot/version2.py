{"filter":false,"title":"version2.py","tooltip":"/context-aware-chatbot/version2.py","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":109,"column":19},"end":{"row":109,"column":21},"action":"insert","lines":["각 "],"id":633},{"start":{"row":109,"column":21},"end":{"row":109,"column":22},"action":"insert","lines":["모"]},{"start":{"row":109,"column":22},"end":{"row":109,"column":23},"action":"insert","lines":["델"]}],[{"start":{"row":109,"column":23},"end":{"row":109,"column":25},"action":"insert","lines":["이 "],"id":634},{"start":{"row":109,"column":25},"end":{"row":109,"column":26},"action":"insert","lines":["ㄷ"]},{"start":{"row":109,"column":25},"end":{"row":109,"column":26},"action":"remove","lines":["ㄷ"]},{"start":{"row":109,"column":24},"end":{"row":109,"column":25},"action":"remove","lines":[" "]},{"start":{"row":109,"column":23},"end":{"row":109,"column":24},"action":"remove","lines":["이"]}],[{"start":{"row":109,"column":23},"end":{"row":109,"column":24},"action":"insert","lines":["한"],"id":635},{"start":{"row":109,"column":24},"end":{"row":109,"column":25},"action":"insert","lines":["테"]},{"start":{"row":109,"column":25},"end":{"row":109,"column":26},"action":"insert","lines":["ㄷ"]},{"start":{"row":109,"column":25},"end":{"row":109,"column":26},"action":"remove","lines":["ㄷ"]}],[{"start":{"row":109,"column":25},"end":{"row":109,"column":27},"action":"insert","lines":["서 "],"id":636},{"start":{"row":109,"column":27},"end":{"row":109,"column":28},"action":"insert","lines":["답"]}],[{"start":{"row":109,"column":28},"end":{"row":109,"column":30},"action":"insert","lines":["변 "],"id":637},{"start":{"row":109,"column":30},"end":{"row":109,"column":31},"action":"insert","lines":["받"]},{"start":{"row":109,"column":31},"end":{"row":109,"column":32},"action":"insert","lines":["아"]},{"start":{"row":109,"column":32},"end":{"row":109,"column":33},"action":"insert","lines":["ㄴ"]},{"start":{"row":109,"column":32},"end":{"row":109,"column":33},"action":"remove","lines":["ㄴ"]}],[{"start":{"row":109,"column":32},"end":{"row":109,"column":33},"action":"insert","lines":["오"],"id":638}],[{"start":{"row":109,"column":33},"end":{"row":109,"column":35},"action":"insert","lines":["는 "],"id":639},{"start":{"row":109,"column":35},"end":{"row":109,"column":37},"action":"insert","lines":["것 "]},{"start":{"row":109,"column":37},"end":{"row":109,"column":38},"action":"insert","lines":["설"]},{"start":{"row":109,"column":38},"end":{"row":109,"column":39},"action":"insert","lines":["정"]},{"start":{"row":109,"column":39},"end":{"row":109,"column":40},"action":"insert","lines":["해"]}],[{"start":{"row":109,"column":40},"end":{"row":109,"column":41},"action":"insert","lines":["보"],"id":640},{"start":{"row":109,"column":41},"end":{"row":109,"column":43},"action":"insert","lines":["자."]}],[{"start":{"row":109,"column":43},"end":{"row":110,"column":0},"action":"insert","lines":["",""],"id":641},{"start":{"row":110,"column":0},"end":{"row":110,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":111,"column":4},"end":{"row":111,"column":6},"action":"insert","lines":["# "],"id":642},{"start":{"row":112,"column":4},"end":{"row":112,"column":6},"action":"insert","lines":["# "]},{"start":{"row":113,"column":4},"end":{"row":113,"column":6},"action":"insert","lines":["# "]},{"start":{"row":114,"column":4},"end":{"row":114,"column":6},"action":"insert","lines":["# "]},{"start":{"row":115,"column":4},"end":{"row":115,"column":6},"action":"insert","lines":["# "]},{"start":{"row":116,"column":4},"end":{"row":116,"column":6},"action":"insert","lines":["# "]},{"start":{"row":118,"column":4},"end":{"row":118,"column":6},"action":"insert","lines":["# "]},{"start":{"row":119,"column":4},"end":{"row":119,"column":6},"action":"insert","lines":["# "]},{"start":{"row":120,"column":4},"end":{"row":120,"column":6},"action":"insert","lines":["# "]}],[{"start":{"row":55,"column":17},"end":{"row":55,"column":18},"action":"remove","lines":["_"],"id":643},{"start":{"row":55,"column":16},"end":{"row":55,"column":17},"action":"remove","lines":["g"]},{"start":{"row":55,"column":15},"end":{"row":55,"column":16},"action":"remove","lines":["n"]},{"start":{"row":55,"column":14},"end":{"row":55,"column":15},"action":"remove","lines":["i"]},{"start":{"row":55,"column":13},"end":{"row":55,"column":14},"action":"remove","lines":["m"]},{"start":{"row":55,"column":12},"end":{"row":55,"column":13},"action":"remove","lines":["a"]},{"start":{"row":55,"column":11},"end":{"row":55,"column":12},"action":"remove","lines":["e"]},{"start":{"row":55,"column":10},"end":{"row":55,"column":11},"action":"remove","lines":["r"]},{"start":{"row":55,"column":9},"end":{"row":55,"column":10},"action":"remove","lines":["t"]}],[{"start":{"row":55,"column":8},"end":{"row":55,"column":9},"action":"remove","lines":["s"],"id":644}],[{"start":{"row":157,"column":0},"end":{"row":162,"column":47},"action":"remove","lines":["        placeholder = st.empty()","        full_response = ''","        # Get the response from the model with streaming","        for chunk in get_streaming_response(MODEL_OPTIONS[option], conversation_history, chunk_handler):","            full_response = chunk","            placeholder.markdown(full_response)"],"id":645}],[{"start":{"row":157,"column":0},"end":{"row":157,"column":4},"action":"insert","lines":["    "],"id":646}],[{"start":{"row":157,"column":4},"end":{"row":157,"column":8},"action":"insert","lines":["    "],"id":647}],[{"start":{"row":157,"column":8},"end":{"row":157,"column":9},"action":"insert","lines":["려"],"id":648},{"start":{"row":157,"column":9},"end":{"row":157,"column":10},"action":"insert","lines":["ㅣ"]},{"start":{"row":157,"column":10},"end":{"row":157,"column":11},"action":"insert","lines":["ㅣ"]},{"start":{"row":157,"column":10},"end":{"row":157,"column":11},"action":"remove","lines":["ㅣ"]},{"start":{"row":157,"column":9},"end":{"row":157,"column":10},"action":"remove","lines":["ㅣ"]},{"start":{"row":157,"column":8},"end":{"row":157,"column":9},"action":"remove","lines":["려"]}],[{"start":{"row":157,"column":8},"end":{"row":157,"column":9},"action":"insert","lines":["f"],"id":649},{"start":{"row":157,"column":9},"end":{"row":157,"column":10},"action":"insert","lines":["u"]},{"start":{"row":157,"column":10},"end":{"row":157,"column":11},"action":"insert","lines":["l"]},{"start":{"row":157,"column":11},"end":{"row":157,"column":12},"action":"insert","lines":["l"]},{"start":{"row":157,"column":12},"end":{"row":157,"column":13},"action":"insert","lines":["_"]},{"start":{"row":157,"column":13},"end":{"row":157,"column":14},"action":"insert","lines":["r"]},{"start":{"row":157,"column":14},"end":{"row":157,"column":15},"action":"insert","lines":["s"]}],[{"start":{"row":157,"column":14},"end":{"row":157,"column":15},"action":"remove","lines":["s"],"id":650}],[{"start":{"row":157,"column":14},"end":{"row":157,"column":15},"action":"insert","lines":["e"],"id":651},{"start":{"row":157,"column":15},"end":{"row":157,"column":16},"action":"insert","lines":["s"]},{"start":{"row":157,"column":16},"end":{"row":157,"column":17},"action":"insert","lines":["p"]},{"start":{"row":157,"column":17},"end":{"row":157,"column":18},"action":"insert","lines":["o"]},{"start":{"row":157,"column":18},"end":{"row":157,"column":19},"action":"insert","lines":["n"]},{"start":{"row":157,"column":19},"end":{"row":157,"column":20},"action":"insert","lines":["s"]}],[{"start":{"row":157,"column":20},"end":{"row":157,"column":21},"action":"insert","lines":["e"],"id":652}],[{"start":{"row":157,"column":21},"end":{"row":157,"column":22},"action":"insert","lines":[" "],"id":653},{"start":{"row":157,"column":22},"end":{"row":157,"column":23},"action":"insert","lines":["="]}],[{"start":{"row":157,"column":23},"end":{"row":157,"column":24},"action":"insert","lines":[" "],"id":654}],[{"start":{"row":157,"column":24},"end":{"row":157,"column":25},"action":"insert","lines":["g"],"id":655},{"start":{"row":157,"column":25},"end":{"row":157,"column":26},"action":"insert","lines":["e"]},{"start":{"row":157,"column":26},"end":{"row":157,"column":27},"action":"insert","lines":["t"]}],[{"start":{"row":157,"column":24},"end":{"row":157,"column":27},"action":"remove","lines":["get"],"id":656},{"start":{"row":157,"column":24},"end":{"row":157,"column":38},"action":"insert","lines":["get_response()"]}],[{"start":{"row":157,"column":37},"end":{"row":157,"column":38},"action":"insert","lines":["c"],"id":657},{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"insert","lines":["i"]},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"insert","lines":["o"]},{"start":{"row":157,"column":40},"end":{"row":157,"column":41},"action":"insert","lines":["n"]}],[{"start":{"row":157,"column":40},"end":{"row":157,"column":41},"action":"remove","lines":["n"],"id":658},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"remove","lines":["o"]},{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"remove","lines":["i"]},{"start":{"row":157,"column":37},"end":{"row":157,"column":38},"action":"remove","lines":["c"]}],[{"start":{"row":157,"column":37},"end":{"row":157,"column":38},"action":"insert","lines":["c"],"id":659},{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"insert","lines":["o"]},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"insert","lines":["n"]}],[{"start":{"row":157,"column":37},"end":{"row":157,"column":40},"action":"remove","lines":["con"],"id":660},{"start":{"row":157,"column":37},"end":{"row":157,"column":57},"action":"insert","lines":["conversation_history"]}],[{"start":{"row":157,"column":37},"end":{"row":157,"column":38},"action":"insert","lines":["m"],"id":661},{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"insert","lines":["d"]},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"insert","lines":["e"]},{"start":{"row":157,"column":40},"end":{"row":157,"column":41},"action":"insert","lines":["o"]},{"start":{"row":157,"column":41},"end":{"row":157,"column":42},"action":"insert","lines":["l"]}],[{"start":{"row":157,"column":41},"end":{"row":157,"column":42},"action":"remove","lines":["l"],"id":662},{"start":{"row":157,"column":40},"end":{"row":157,"column":41},"action":"remove","lines":["o"]},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"remove","lines":["e"]},{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"remove","lines":["d"]}],[{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"insert","lines":["o"],"id":663},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"insert","lines":["d"]},{"start":{"row":157,"column":40},"end":{"row":157,"column":41},"action":"insert","lines":["e"]},{"start":{"row":157,"column":41},"end":{"row":157,"column":42},"action":"insert","lines":["l"]},{"start":{"row":157,"column":42},"end":{"row":157,"column":43},"action":"insert","lines":["_"]},{"start":{"row":157,"column":43},"end":{"row":157,"column":44},"action":"insert","lines":["i"]},{"start":{"row":157,"column":44},"end":{"row":157,"column":45},"action":"insert","lines":["d"]}],[{"start":{"row":157,"column":44},"end":{"row":157,"column":45},"action":"remove","lines":["d"],"id":664},{"start":{"row":157,"column":43},"end":{"row":157,"column":44},"action":"remove","lines":["i"]},{"start":{"row":157,"column":42},"end":{"row":157,"column":43},"action":"remove","lines":["_"]},{"start":{"row":157,"column":41},"end":{"row":157,"column":42},"action":"remove","lines":["l"]},{"start":{"row":157,"column":40},"end":{"row":157,"column":41},"action":"remove","lines":["e"]},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"remove","lines":["d"]},{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"remove","lines":["o"]},{"start":{"row":157,"column":37},"end":{"row":157,"column":38},"action":"remove","lines":["m"]}],[{"start":{"row":157,"column":37},"end":{"row":157,"column":38},"action":"insert","lines":["o"],"id":665},{"start":{"row":157,"column":38},"end":{"row":157,"column":39},"action":"insert","lines":["p"]},{"start":{"row":157,"column":39},"end":{"row":157,"column":40},"action":"insert","lines":["t"]},{"start":{"row":157,"column":40},"end":{"row":157,"column":41},"action":"insert","lines":["i"]},{"start":{"row":157,"column":41},"end":{"row":157,"column":42},"action":"insert","lines":["u"]},{"start":{"row":157,"column":42},"end":{"row":157,"column":43},"action":"insert","lines":["o"]}],[{"start":{"row":157,"column":42},"end":{"row":157,"column":43},"action":"remove","lines":["o"],"id":666},{"start":{"row":157,"column":41},"end":{"row":157,"column":42},"action":"remove","lines":["u"]}],[{"start":{"row":157,"column":41},"end":{"row":157,"column":42},"action":"insert","lines":["o"],"id":667},{"start":{"row":157,"column":42},"end":{"row":157,"column":43},"action":"insert","lines":["n"]},{"start":{"row":157,"column":43},"end":{"row":157,"column":44},"action":"insert","lines":[","]}],[{"start":{"row":157,"column":44},"end":{"row":157,"column":45},"action":"insert","lines":[" "],"id":668}],[{"start":{"row":55,"column":40},"end":{"row":55,"column":57},"action":"remove","lines":["treaming_callback"],"id":669},{"start":{"row":55,"column":39},"end":{"row":55,"column":40},"action":"remove","lines":["s"]},{"start":{"row":55,"column":38},"end":{"row":55,"column":39},"action":"remove","lines":[" "]},{"start":{"row":55,"column":37},"end":{"row":55,"column":38},"action":"remove","lines":[","]}],[{"start":{"row":109,"column":0},"end":{"row":127,"column":80},"action":"remove","lines":["    #일단 스트리밍 방식말고 각각 모델한테서 답변 받아오는 것 설정해보자.","    ","    # response = bedrock_runtime.invoke_model_with_response_stream(","    #     body=body,","    #     modelId=modelId,","    #     contentType=\"application/json\",","    # )","    # response_body = response.get(\"body\")","    ","    # print(\"++++++++++++++++++++RESPONSE++++++++++++++++++++\")","    # print(response_body.shape())","    # print(response_body)","    ","    # if 'amazon' in modelId:","    #     response = response_body.get('results')[0].get('outputText')","    # elif 'anthropic' in modelId:","    #     response = response_body.get('completion')","    # elif 'ai21' in modelId:","    #     response = response_body.get('completions')[0].get('data').get('text')"],"id":670},{"start":{"row":108,"column":4},"end":{"row":109,"column":0},"action":"remove","lines":["",""]},{"start":{"row":108,"column":0},"end":{"row":108,"column":4},"action":"remove","lines":["    "]},{"start":{"row":107,"column":4},"end":{"row":108,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":75,"column":0},"end":{"row":86,"column":9},"action":"remove","lines":["        body = json.dumps(","            {","                \"anthropic_version\": \"bedrock-2023-05-31\",","                \"max_tokens\": 1000,","                \"messages\": [","                    {","                        \"role\": \"user\",","                        \"content\": [{\"type\": \"text\", \"text\": prompt_data}],","                    }","                ],","            }","        )"],"id":671}],[{"start":{"row":75,"column":0},"end":{"row":93,"column":53},"action":"insert","lines":["    body = json.dumps(","        {","            \"anthropic_version\": \"bedrock-2023-05-31\",","            \"max_tokens\": 1000,","            \"messages\": [","                {","                    \"role\": \"user\",","                    \"content\": [{\"type\": \"text\", \"text\": prompt}],","                }","            ],","        }","    )","","    response = bedrock_runtime.invoke_model(","        modelId=\"anthropic.claude-3-sonnet-20240229-v1:0\",","        body=body,","    )","    response_body = json.loads(response.get(\"body\").read())","    output_text = response_body[\"content\"][0][\"text\"]"],"id":672}],[{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"insert","lines":["    "],"id":673},{"start":{"row":76,"column":0},"end":{"row":76,"column":4},"action":"insert","lines":["    "]},{"start":{"row":77,"column":0},"end":{"row":77,"column":4},"action":"insert","lines":["    "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":4},"action":"insert","lines":["    "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":4},"action":"insert","lines":["    "]},{"start":{"row":80,"column":0},"end":{"row":80,"column":4},"action":"insert","lines":["    "]},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":4},"action":"insert","lines":["    "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":4},"action":"insert","lines":["    "]},{"start":{"row":84,"column":0},"end":{"row":84,"column":4},"action":"insert","lines":["    "]},{"start":{"row":85,"column":0},"end":{"row":85,"column":4},"action":"insert","lines":["    "]},{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "]},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]},{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "]},{"start":{"row":89,"column":0},"end":{"row":89,"column":4},"action":"insert","lines":["    "]},{"start":{"row":90,"column":0},"end":{"row":90,"column":4},"action":"insert","lines":["    "]},{"start":{"row":91,"column":0},"end":{"row":91,"column":4},"action":"insert","lines":["    "]},{"start":{"row":92,"column":0},"end":{"row":92,"column":4},"action":"insert","lines":["    "]},{"start":{"row":93,"column":0},"end":{"row":93,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":82,"column":67},"end":{"row":82,"column":68},"action":"insert","lines":["_"],"id":674},{"start":{"row":82,"column":68},"end":{"row":82,"column":69},"action":"insert","lines":["d"]},{"start":{"row":82,"column":69},"end":{"row":82,"column":70},"action":"insert","lines":["a"]},{"start":{"row":82,"column":70},"end":{"row":82,"column":71},"action":"insert","lines":["t"]},{"start":{"row":82,"column":71},"end":{"row":82,"column":72},"action":"insert","lines":["a"]}],[{"start":{"row":116,"column":13},"end":{"row":116,"column":24},"action":"remove","lines":["sponse_body"],"id":675},{"start":{"row":116,"column":12},"end":{"row":116,"column":13},"action":"remove","lines":["e"]},{"start":{"row":116,"column":11},"end":{"row":116,"column":12},"action":"remove","lines":["r"]}],[{"start":{"row":116,"column":11},"end":{"row":116,"column":12},"action":"insert","lines":["o"],"id":676},{"start":{"row":116,"column":12},"end":{"row":116,"column":13},"action":"insert","lines":["u"]},{"start":{"row":116,"column":13},"end":{"row":116,"column":14},"action":"insert","lines":["t"]}],[{"start":{"row":116,"column":11},"end":{"row":116,"column":14},"action":"remove","lines":["out"],"id":677},{"start":{"row":116,"column":11},"end":{"row":116,"column":22},"action":"insert","lines":["output_text"]}],[{"start":{"row":112,"column":0},"end":{"row":113,"column":60},"action":"remove","lines":["    #response = bedrock_runtime.invoke_model(body=body, modelId=modelId)","    #response_body = json.loads(response.get('body').read())"],"id":678}],[{"start":{"row":113,"column":4},"end":{"row":114,"column":0},"action":"remove","lines":["",""],"id":679},{"start":{"row":113,"column":0},"end":{"row":113,"column":4},"action":"remove","lines":["    "]}],[{"start":{"row":18,"column":0},"end":{"row":18,"column":2},"action":"insert","lines":["# "],"id":680},{"start":{"row":19,"column":0},"end":{"row":19,"column":2},"action":"insert","lines":["# "]}],[{"start":{"row":130,"column":0},"end":{"row":130,"column":61},"action":"remove","lines":["    st.session_state.token_count += count_tokens(user_prompt)"],"id":681}],[{"start":{"row":145,"column":0},"end":{"row":146,"column":0},"action":"remove","lines":["        st.session_state.token_count += count_tokens(full_response)",""],"id":682}],[{"start":{"row":143,"column":4},"end":{"row":143,"column":8},"action":"remove","lines":["    "],"id":683},{"start":{"row":143,"column":0},"end":{"row":143,"column":4},"action":"remove","lines":["    "]},{"start":{"row":142,"column":66},"end":{"row":143,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":139,"column":5},"end":{"row":140,"column":0},"action":"insert","lines":["",""],"id":684},{"start":{"row":140,"column":0},"end":{"row":140,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":143,"column":1},"end":{"row":144,"column":89},"action":"remove","lines":["       full_response = get_response(option, conversation_history)","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": full_response})"],"id":685},{"start":{"row":143,"column":0},"end":{"row":143,"column":1},"action":"remove","lines":[" "]},{"start":{"row":142,"column":40},"end":{"row":143,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":142,"column":39},"end":{"row":142,"column":40},"action":"remove","lines":[" "],"id":686},{"start":{"row":142,"column":38},"end":{"row":142,"column":39},"action":"remove","lines":[" "]}],[{"start":{"row":139,"column":5},"end":{"row":140,"column":0},"action":"insert","lines":["",""],"id":687},{"start":{"row":140,"column":0},"end":{"row":140,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":140,"column":4},"end":{"row":141,"column":89},"action":"insert","lines":["        full_response = get_response(option, conversation_history)","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": full_response})"],"id":688}],[{"start":{"row":140,"column":12},"end":{"row":140,"column":13},"action":"remove","lines":["f"],"id":689},{"start":{"row":140,"column":8},"end":{"row":140,"column":12},"action":"remove","lines":["    "]},{"start":{"row":140,"column":4},"end":{"row":140,"column":8},"action":"remove","lines":["    "]}],[{"start":{"row":140,"column":4},"end":{"row":140,"column":5},"action":"insert","lines":["f"],"id":690}],[{"start":{"row":141,"column":8},"end":{"row":141,"column":9},"action":"remove","lines":["s"],"id":691},{"start":{"row":141,"column":4},"end":{"row":141,"column":8},"action":"remove","lines":["    "]}],[{"start":{"row":141,"column":4},"end":{"row":141,"column":5},"action":"insert","lines":["s"],"id":692}],[{"start":{"row":146,"column":0},"end":{"row":148,"column":61},"action":"remove","lines":["# Display updated token count in the sidebar","with st.sidebar:","    st.write(f\"Total Tokens: {st.session_state.token_count}\")"],"id":693}],[{"start":{"row":143,"column":0},"end":{"row":143,"column":4},"action":"remove","lines":["    "],"id":694}],[{"start":{"row":144,"column":38},"end":{"row":145,"column":0},"action":"insert","lines":["",""],"id":695},{"start":{"row":145,"column":0},"end":{"row":145,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":145,"column":8},"end":{"row":145,"column":9},"action":"insert","lines":["t"],"id":696},{"start":{"row":145,"column":9},"end":{"row":145,"column":10},"action":"insert","lines":["."]}],[{"start":{"row":145,"column":9},"end":{"row":145,"column":10},"action":"remove","lines":["."],"id":697},{"start":{"row":145,"column":8},"end":{"row":145,"column":9},"action":"remove","lines":["t"]}],[{"start":{"row":145,"column":8},"end":{"row":145,"column":9},"action":"insert","lines":["s"],"id":698},{"start":{"row":145,"column":9},"end":{"row":145,"column":10},"action":"insert","lines":["t"]},{"start":{"row":145,"column":10},"end":{"row":145,"column":11},"action":"insert","lines":["."]},{"start":{"row":145,"column":11},"end":{"row":145,"column":12},"action":"insert","lines":["m"]},{"start":{"row":145,"column":12},"end":{"row":145,"column":13},"action":"insert","lines":["a"]},{"start":{"row":145,"column":13},"end":{"row":145,"column":14},"action":"insert","lines":["r"]},{"start":{"row":145,"column":14},"end":{"row":145,"column":15},"action":"insert","lines":["k"]},{"start":{"row":145,"column":15},"end":{"row":145,"column":16},"action":"insert","lines":["d"]},{"start":{"row":145,"column":16},"end":{"row":145,"column":17},"action":"insert","lines":["o"]}],[{"start":{"row":145,"column":17},"end":{"row":145,"column":18},"action":"insert","lines":["w"],"id":699},{"start":{"row":145,"column":18},"end":{"row":145,"column":19},"action":"insert","lines":["n"]}],[{"start":{"row":145,"column":18},"end":{"row":145,"column":19},"action":"remove","lines":["n"],"id":700},{"start":{"row":145,"column":17},"end":{"row":145,"column":18},"action":"remove","lines":["w"]},{"start":{"row":145,"column":16},"end":{"row":145,"column":17},"action":"remove","lines":["o"]},{"start":{"row":145,"column":15},"end":{"row":145,"column":16},"action":"remove","lines":["d"]},{"start":{"row":145,"column":14},"end":{"row":145,"column":15},"action":"remove","lines":["k"]},{"start":{"row":145,"column":13},"end":{"row":145,"column":14},"action":"remove","lines":["r"]},{"start":{"row":145,"column":12},"end":{"row":145,"column":13},"action":"remove","lines":["a"]},{"start":{"row":145,"column":11},"end":{"row":145,"column":12},"action":"remove","lines":["m"]}],[{"start":{"row":145,"column":11},"end":{"row":145,"column":12},"action":"insert","lines":["w"],"id":701},{"start":{"row":145,"column":12},"end":{"row":145,"column":13},"action":"insert","lines":["i"]},{"start":{"row":145,"column":13},"end":{"row":145,"column":14},"action":"insert","lines":["r"]}],[{"start":{"row":145,"column":13},"end":{"row":145,"column":14},"action":"remove","lines":["r"],"id":702},{"start":{"row":145,"column":12},"end":{"row":145,"column":13},"action":"remove","lines":["i"]}],[{"start":{"row":145,"column":12},"end":{"row":145,"column":13},"action":"insert","lines":["r"],"id":703},{"start":{"row":145,"column":13},"end":{"row":145,"column":14},"action":"insert","lines":["i"]},{"start":{"row":145,"column":14},"end":{"row":145,"column":15},"action":"insert","lines":["t"]},{"start":{"row":145,"column":15},"end":{"row":145,"column":16},"action":"insert","lines":["e"]}],[{"start":{"row":145,"column":16},"end":{"row":145,"column":18},"action":"insert","lines":["()"],"id":704}],[{"start":{"row":145,"column":17},"end":{"row":145,"column":18},"action":"insert","lines":["d"],"id":705}],[{"start":{"row":145,"column":17},"end":{"row":145,"column":18},"action":"remove","lines":["d"],"id":706}],[{"start":{"row":145,"column":17},"end":{"row":145,"column":18},"action":"insert","lines":["f"],"id":707},{"start":{"row":145,"column":18},"end":{"row":145,"column":19},"action":"insert","lines":["u"]},{"start":{"row":145,"column":19},"end":{"row":145,"column":20},"action":"insert","lines":["l"]},{"start":{"row":145,"column":20},"end":{"row":145,"column":21},"action":"insert","lines":["l"]},{"start":{"row":145,"column":21},"end":{"row":145,"column":22},"action":"insert","lines":["_"]},{"start":{"row":145,"column":22},"end":{"row":145,"column":23},"action":"insert","lines":["r"]},{"start":{"row":145,"column":23},"end":{"row":145,"column":24},"action":"insert","lines":["e"]}],[{"start":{"row":145,"column":17},"end":{"row":145,"column":24},"action":"remove","lines":["full_re"],"id":708},{"start":{"row":145,"column":17},"end":{"row":145,"column":30},"action":"insert","lines":["full_response"]}],[{"start":{"row":145,"column":30},"end":{"row":145,"column":31},"action":"insert","lines":["s"],"id":709}],[{"start":{"row":145,"column":30},"end":{"row":145,"column":31},"action":"remove","lines":["s"],"id":710}],[{"start":{"row":125,"column":0},"end":{"row":126,"column":0},"action":"remove","lines":["    st.write(f\"Total Tokens: {st.session_state.token_count}\")",""],"id":711}],[{"start":{"row":139,"column":33},"end":{"row":139,"column":34},"action":"insert","lines":["["],"id":712}],[{"start":{"row":139,"column":40},"end":{"row":139,"column":41},"action":"insert","lines":["]"],"id":713}],[{"start":{"row":139,"column":33},"end":{"row":139,"column":34},"action":"insert","lines":["m"],"id":714},{"start":{"row":139,"column":34},"end":{"row":139,"column":35},"action":"insert","lines":["O"]}],[{"start":{"row":139,"column":34},"end":{"row":139,"column":35},"action":"remove","lines":["O"],"id":715},{"start":{"row":139,"column":33},"end":{"row":139,"column":34},"action":"remove","lines":["m"]}],[{"start":{"row":139,"column":33},"end":{"row":139,"column":34},"action":"insert","lines":["M"],"id":716},{"start":{"row":139,"column":34},"end":{"row":139,"column":35},"action":"insert","lines":["O"]},{"start":{"row":139,"column":35},"end":{"row":139,"column":36},"action":"insert","lines":["D"]},{"start":{"row":139,"column":36},"end":{"row":139,"column":37},"action":"insert","lines":["E"]},{"start":{"row":139,"column":37},"end":{"row":139,"column":38},"action":"insert","lines":["L"]},{"start":{"row":139,"column":38},"end":{"row":139,"column":39},"action":"insert","lines":["_"]}],[{"start":{"row":139,"column":33},"end":{"row":139,"column":39},"action":"remove","lines":["MODEL_"],"id":717},{"start":{"row":139,"column":33},"end":{"row":139,"column":46},"action":"insert","lines":["MODEL_OPTIONS"]}],[{"start":{"row":145,"column":0},"end":{"row":145,"column":1},"action":"insert","lines":["s"],"id":718}],[{"start":{"row":145,"column":0},"end":{"row":145,"column":1},"action":"remove","lines":["s"],"id":719}],[{"start":{"row":84,"column":18},"end":{"row":84,"column":19},"action":"insert","lines":["\\"],"id":720}],[{"start":{"row":84,"column":18},"end":{"row":84,"column":19},"action":"remove","lines":["\\"],"id":721}],[{"start":{"row":89,"column":59},"end":{"row":89,"column":60},"action":"remove","lines":["0"],"id":722},{"start":{"row":89,"column":58},"end":{"row":89,"column":59},"action":"remove","lines":[":"]},{"start":{"row":89,"column":57},"end":{"row":89,"column":58},"action":"remove","lines":["1"]},{"start":{"row":89,"column":56},"end":{"row":89,"column":57},"action":"remove","lines":["v"]},{"start":{"row":89,"column":55},"end":{"row":89,"column":56},"action":"remove","lines":["-"]},{"start":{"row":89,"column":54},"end":{"row":89,"column":55},"action":"remove","lines":["9"]},{"start":{"row":89,"column":53},"end":{"row":89,"column":54},"action":"remove","lines":["2"]},{"start":{"row":89,"column":52},"end":{"row":89,"column":53},"action":"remove","lines":["2"]},{"start":{"row":89,"column":51},"end":{"row":89,"column":52},"action":"remove","lines":["0"]},{"start":{"row":89,"column":50},"end":{"row":89,"column":51},"action":"remove","lines":["4"]},{"start":{"row":89,"column":49},"end":{"row":89,"column":50},"action":"remove","lines":["2"]},{"start":{"row":89,"column":48},"end":{"row":89,"column":49},"action":"remove","lines":["0"]},{"start":{"row":89,"column":47},"end":{"row":89,"column":48},"action":"remove","lines":["2"]},{"start":{"row":89,"column":46},"end":{"row":89,"column":47},"action":"remove","lines":["-"]},{"start":{"row":89,"column":45},"end":{"row":89,"column":46},"action":"remove","lines":["t"]},{"start":{"row":89,"column":44},"end":{"row":89,"column":45},"action":"remove","lines":["e"]},{"start":{"row":89,"column":43},"end":{"row":89,"column":44},"action":"remove","lines":["n"]},{"start":{"row":89,"column":42},"end":{"row":89,"column":43},"action":"remove","lines":["n"]},{"start":{"row":89,"column":41},"end":{"row":89,"column":42},"action":"remove","lines":["o"]}],[{"start":{"row":89,"column":40},"end":{"row":89,"column":41},"action":"remove","lines":["s"],"id":723},{"start":{"row":89,"column":39},"end":{"row":89,"column":40},"action":"remove","lines":["-"]},{"start":{"row":89,"column":38},"end":{"row":89,"column":39},"action":"remove","lines":["3"]},{"start":{"row":89,"column":37},"end":{"row":89,"column":38},"action":"remove","lines":["-"]},{"start":{"row":89,"column":36},"end":{"row":89,"column":37},"action":"remove","lines":["e"]},{"start":{"row":89,"column":35},"end":{"row":89,"column":36},"action":"remove","lines":["d"]},{"start":{"row":89,"column":34},"end":{"row":89,"column":35},"action":"remove","lines":["u"]},{"start":{"row":89,"column":33},"end":{"row":89,"column":34},"action":"remove","lines":["a"]},{"start":{"row":89,"column":32},"end":{"row":89,"column":33},"action":"remove","lines":["l"]}],[{"start":{"row":89,"column":31},"end":{"row":89,"column":32},"action":"remove","lines":["c"],"id":724},{"start":{"row":89,"column":30},"end":{"row":89,"column":31},"action":"remove","lines":["."]},{"start":{"row":89,"column":29},"end":{"row":89,"column":30},"action":"remove","lines":["c"]},{"start":{"row":89,"column":28},"end":{"row":89,"column":29},"action":"remove","lines":["i"]},{"start":{"row":89,"column":27},"end":{"row":89,"column":28},"action":"remove","lines":["p"]},{"start":{"row":89,"column":26},"end":{"row":89,"column":27},"action":"remove","lines":["o"]},{"start":{"row":89,"column":25},"end":{"row":89,"column":26},"action":"remove","lines":["r"]}],[{"start":{"row":89,"column":25},"end":{"row":89,"column":26},"action":"remove","lines":["\""],"id":725},{"start":{"row":89,"column":24},"end":{"row":89,"column":25},"action":"remove","lines":["h"]},{"start":{"row":89,"column":23},"end":{"row":89,"column":24},"action":"remove","lines":["t"]},{"start":{"row":89,"column":22},"end":{"row":89,"column":23},"action":"remove","lines":["n"]},{"start":{"row":89,"column":21},"end":{"row":89,"column":22},"action":"remove","lines":["a"]},{"start":{"row":89,"column":20},"end":{"row":89,"column":21},"action":"remove","lines":["\""]}],[{"start":{"row":89,"column":20},"end":{"row":89,"column":21},"action":"insert","lines":["m"],"id":726},{"start":{"row":89,"column":21},"end":{"row":89,"column":22},"action":"insert","lines":["o"]},{"start":{"row":89,"column":22},"end":{"row":89,"column":23},"action":"insert","lines":["d"]},{"start":{"row":89,"column":23},"end":{"row":89,"column":24},"action":"insert","lines":["e"]},{"start":{"row":89,"column":24},"end":{"row":89,"column":25},"action":"insert","lines":["l"]},{"start":{"row":89,"column":25},"end":{"row":89,"column":26},"action":"insert","lines":["I"]},{"start":{"row":89,"column":26},"end":{"row":89,"column":27},"action":"insert","lines":["D"]}],[{"start":{"row":89,"column":26},"end":{"row":89,"column":27},"action":"remove","lines":["D"],"id":727}],[{"start":{"row":89,"column":26},"end":{"row":89,"column":27},"action":"insert","lines":["d"],"id":728}],[{"start":{"row":93,"column":57},"end":{"row":94,"column":0},"action":"insert","lines":["",""],"id":729},{"start":{"row":94,"column":0},"end":{"row":94,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":0,"column":0},"end":{"row":148,"column":0},"action":"remove","lines":["import streamlit as st","import json","import boto3","import logging","","# Configure logging","","# Bedrock runtime","bedrock_runtime = boto3.client(service_name=\"bedrock-runtime\", region_name=\"us-east-1\")","","st.title(\"Chatbot powered by Bedrock with multi-choice model\")","","# Initialize session state if there are no messages","if \"messages\" not in st.session_state:","    st.session_state.messages = []","    st.session_state.token_count = 0","","# Function to estimate the number of tokens in a message","# def count_tokens(text):","#     return len(text.split())","","# Display chat messages","for message in st.session_state.messages:","    with st.chat_message(message[\"role\"]):","        st.markdown(message[\"content\"])","","def clear_screen():","    st.session_state.messages = [{\"role\": \"assistant\", \"content\": \"How may I assist you today?\"}]","    st.session_state.token_count = 0","","def chunk_handler(chunk):","    logging.info(f\"Chunk received: {chunk}\")","    text = \"\"","    chunk_type = chunk.get(\"type\")","    if chunk_type == \"message_start\":","        text = \"\"","    elif chunk_type == \"content_block_start\":","        text = chunk[\"content_block\"][\"text\"]","    elif chunk_type == \"content_block_delta\":","        text = chunk[\"delta\"][\"text\"]","    elif chunk_type == \"message_delta\":","        text = \"\"","    elif chunk_type == \"message_stop\":","        text = \"\"","    return text","","# Define model options with their request and response formats using lambda functions","MODEL_OPTIONS = {","    \"Claude\": \"anthropic.claude-3-sonnet-20240229-v1:0\",","    \"Llama\": \"meta.llama2-70b-chat-v1\",","    \"AI21 Lab\": \"ai21.j2-ultra-v1\",","    \"Amazon Titan\": \"amazon.titan-embed-text-v1\",","    }","","    ","def get_response(modelId, prompt_data):","    print(\"Model {} \" .format(modelId))","    print(\"Message {} \".format(prompt_data))","    max_tokens = 4096","    temperature = 0,","    top_p = 0.9","    if 'amazon' in modelId:","        print(\"amazon selected\")","        body = json.dumps({","            \"inputText\": prompt_data,","            \"textGenerationConfig\":","            {","                \"maxTokenCount\":max_tokens,","                \"stopSequences\":[],","                \"temperature\":temperature,","                \"topP\":top_p","            }","        })","    elif 'anthropic' in modelId:","        print(\"claude selected\")","        body = json.dumps(","            {","                \"anthropic_version\": \"bedrock-2023-05-31\",","                \"max_tokens\": 1000,","                \"messages\": [","                    {","                        \"role\": \"user\",","                        \"content\": [{\"type\": \"text\", \"text\": prompt_data}],","                    }","                ],","            }","        )","    ","        response = bedrock_runtime.invoke_model(","            modelId=modelId,","            body=body,","        )","        response_body = json.loads(response.get(\"body\").read())","        output_text = response_body[\"content\"][0][\"text\"]","        ","    elif 'ai21' in modelId:","        print","        body = json.dumps({","            \"prompt\": prompt_data,","            \"maxTokens\": max_tokens,","            \"stopSequences\":[],","            \"temperature\":temperature,","            \"topP\":top_p","        })","    elif 'stability' in modelId:","        body = json.dumps({","            \"text_prompts\":[{","                \"text\":prompt_data","            }]","        }) ","    else:","        print('Parameter model must be one of titan, claude, j2, or sd')","        return","","","    return output_text","","# Sidebar","with st.sidebar:","    st.title('Streamlit Chat')","    st.subheader('With DynamoDB Memory :brain:')","    st.button('Clear Screen', on_click=clear_screen)","    ","    option = st.selectbox(","        \"What model would you like to use?\",","        options=list(MODEL_OPTIONS.keys()))","    st.write(\"You selected:\", option)","","if user_prompt := st.chat_input(\"What's Up?\"):","    st.session_state.messages.append({\"role\": \"user\", \"content\": user_prompt})","","    ","    with st.chat_message(\"user\"):","        st.write(user_prompt)","    ","    # Prepare the conversation history for the model","    conversation_history = [","        {\"role\": msg[\"role\"], \"content\": msg[\"content\"]}","        for msg in st.session_state.messages","    ]","    full_response = get_response(MODEL_OPTIONS[option], conversation_history)","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": full_response})","    ","","    with st.chat_message(\"assistant\"):","        st.write(full_response)","","",""],"id":731},{"start":{"row":0,"column":0},"end":{"row":143,"column":0},"action":"insert","lines":["import streamlit as st","import json","import boto3","import logging","","# Configure logging","logging.basicConfig(level=logging.DEBUG, format='%(asctime)s %(levelname)s %(message)s')","","# Bedrock runtime","bedrock_runtime = boto3.client(service_name=\"bedrock-runtime\", region_name=\"us-east-1\")","","st.title(\"Chatbot powered by Bedrock with multi-choice model\")","","# Initialize session state if there are no messages","if \"messages\" not in st.session_state:","    st.session_state.messages = []","    st.session_state.token_count = 0","","# Display chat messages","for message in st.session_state.messages:","    with st.chat_message(message[\"role\"]):","        st.markdown(message[\"content\"])","","def clear_screen():","    st.session_state.messages = [{\"role\": \"assistant\", \"content\": \"How may I assist you today?\"}]","    st.session_state.token_count = 0","","# Define model options","MODEL_OPTIONS = {","    \"Claude\": \"anthropic.claude-3-sonnet-20240229-v1:0\",","    \"Llama\": \"meta.llama2-70b-chat-v1\",","    \"AI21 Lab\": \"ai21.j2-ultra-v1\",","    \"Amazon Titan\": \"amazon.titan-embed-text-v1\",","}","","def get_response(modelId, prompt_data):","    print(\"Model {} \".format(modelId))","    print(\"Message {} \".format(prompt_data))","    max_tokens = 4096","    temperature = 0","    top_p = 0.9","    output_text = \"\"","","    if 'amazon' in modelId:","        print(\"amazon selected\")","        body = json.dumps({","            \"inputText\": prompt_data,","            \"textGenerationConfig\": {","                \"maxTokenCount\": max_tokens,","                \"stopSequences\": [],","                \"temperature\": temperature,","                \"topP\": top_p","            }","        })","        response = bedrock_runtime.invoke_model(","            modelId=modelId,","            body=body,","        )","        response_body = json.loads(response.get(\"body\").read())","        output_text = response_body[\"results\"][0][\"outputText\"]","    elif 'anthropic' in modelId:","        print(\"claude selected\")","        body = json.dumps(","            {","                \"anthropic_version\": \"bedrock-2023-05-31\",","                \"max_tokens\": 1000,","                \"messages\": [","                    {","                        \"role\": \"user\",","                        \"content\": [{\"type\": \"text\", \"text\": prompt_data}],","                    }","                ],","            }","        )","        response = bedrock_runtime.invoke_model(","            modelId=modelId,","            body=body,","        )","        response_body = json.loads(response.get(\"body\").read())","        output_text = response_body[\"completion\"]","    elif 'ai21' in modelId:","        print(\"ai21 selected\")","        body = json.dumps({","            \"prompt\": prompt_data,","            \"maxTokens\": max_tokens,","            \"stopSequences\": [],","            \"temperature\": temperature,","            \"topP\": top_p","        })","        response = bedrock_runtime.invoke_model(","            modelId=modelId,","            body=body,","        )","        response_body = json.loads(response.get(\"body\").read())","        output_text = response_body[\"completions\"][0][\"data\"][\"text\"]","    elif 'stability' in modelId:","        body = json.dumps({","            \"text_prompts\": [{","                \"text\": prompt_data","            }]","        })","        response = bedrock_runtime.invoke_model(","            modelId=modelId,","            body=body,","        )","        response_body = json.loads(response.get(\"body\").read())","        output_text = response_body[\"artifacts\"][0][\"base64\"]","    else:","        print('Parameter model must be one of titan, claude, j2, or sd')","        return","","    return output_text","","# Sidebar","with st.sidebar:","    st.title('Streamlit Chat')","    st.subheader('With DynamoDB Memory :brain:')","    st.button('Clear Screen', on_click=clear_screen)","    ","    option = st.selectbox(","        \"What model would you like to use?\",","        options=list(MODEL_OPTIONS.keys()))","    st.write(\"You selected:\", option)","","if user_prompt := st.chat_input(\"What's Up?\"):","    st.session_state.messages.append({\"role\": \"user\", \"content\": user_prompt})","","    with st.chat_message(\"user\"):","        st.markdown(user_prompt)","    ","    # Prepare the conversation history for the model","    conversation_history = \"\\n\".join(","        f'{msg[\"role\"]}: {msg[\"content\"]}' for msg in st.session_state.messages","    )","    full_response = get_response(MODEL_OPTIONS[option], conversation_history)","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": full_response})","","    with st.chat_message(\"assistant\"):","        st.markdown(full_response)","","# Display updated token count in the sidebar","with st.sidebar:","    st.write(f\"Total Tokens: {st.session_state.token_count}\")",""]}],[{"start":{"row":139,"column":0},"end":{"row":143,"column":0},"action":"remove","lines":["","# Display updated token count in the sidebar","with st.sidebar:","    st.write(f\"Total Tokens: {st.session_state.token_count}\")",""],"id":732}],[{"start":{"row":78,"column":0},"end":{"row":79,"column":49},"action":"remove","lines":["        response_body = json.loads(response.get(\"body\").read())","        output_text = response_body[\"completion\"]"],"id":733},{"start":{"row":78,"column":0},"end":{"row":79,"column":53},"action":"insert","lines":["    response_body = json.loads(response.get(\"body\").read())","    output_text = response_body[\"content\"][0][\"text\"]"]}],[{"start":{"row":78,"column":0},"end":{"row":78,"column":4},"action":"insert","lines":["    "],"id":734},{"start":{"row":79,"column":0},"end":{"row":79,"column":4},"action":"insert","lines":["    "]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":79,"column":57},"end":{"row":79,"column":57},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1717412301736,"hash":"e535fb5b27c00e7b729963bf14a77f5ab258ce3e"}