{"filter":false,"title":"streaming.py","tooltip":"/context-aware-chatbot/streaming.py","undoManager":{"mark":22,"position":22,"stack":[[{"start":{"row":0,"column":0},"end":{"row":11,"column":62},"action":"insert","lines":["import streamlit as st","import json","import boto3","import logging","","# Configure logging","#logging.basicConfig(level=logging.DEBUG, format='%(asctime)s %(levelname)s %(message)s')","","# Bedrock runtime","bedrock_runtime = boto3.client(service_name=\"bedrock-runtime\", region_name=\"us-east-1\")","","st.title(\"Chatbot powered by Bedrock with multi-choice model\")"],"id":25}],[{"start":{"row":0,"column":0},"end":{"row":11,"column":62},"action":"remove","lines":["import streamlit as st","import json","import boto3","import logging","","# Configure logging","#logging.basicConfig(level=logging.DEBUG, format='%(asctime)s %(levelname)s %(message)s')","","# Bedrock runtime","bedrock_runtime = boto3.client(service_name=\"bedrock-runtime\", region_name=\"us-east-1\")","","st.title(\"Chatbot powered by Bedrock with multi-choice model\")"],"id":26},{"start":{"row":0,"column":0},"end":{"row":108,"column":0},"action":"insert","lines":["import streamlit as st","import json","import boto3","","# Bedrock runtime","bedrock_runtime = boto3.client(service_name=\"bedrock-runtime\", region_name=\"us-east-1\")","","st.title(\"Chatbot powered by Bedrock with multi-choice model\")","","# Initialize session state if there are no messages","if \"messages\" not in st.session_state:","    st.session_state.messages = []","    st.session_state.token_count = 0","","# Function to estimate the number of tokens in a message","def count_tokens(text):","    return len(text.split())","","# Display chat messages","for message in st.session_state.messages:","    with st.chat_message(message[\"role\"]):","        st.markdown(message[\"content\"])","","def clear_screen():","    st.session_state.messages = [{\"role\": \"assistant\", \"content\": \"How may I assist you today?\"}]","    st.session_state.token_count = 0","","def chunk_handler(chunk):","    text = \"\"","    chunk_type = chunk.get(\"type\")","    if chunk_type == \"message_start\":","        text = \"\"","    elif chunk_type == \"content_block_start\":","        text = chunk[\"content_block\"][\"text\"]","    elif chunk_type == \"content_block_delta\":","        text = chunk[\"delta\"][\"text\"]","    elif chunk_type == \"message_delta\":","        text = \"\"","    elif chunk_type == \"message_stop\":","        text = \"\"","    return text","","def get_streaming_response(messages, streaming_callback):","    try:","        body = json.dumps(","            {","                \"anthropic_version\": \"bedrock-2023-05-31\",","                \"max_tokens\": 1000,","                \"messages\": messages,","            }","        )","","        # stream","        response = bedrock_runtime.invoke_model_with_response_stream(","            modelId=\"anthropic.claude-3-sonnet-20240229-v1:0\",","            body=body,","        )","        stream = response.get(\"body\")","","        if stream:","            complete_response = \"\"","            for event in stream:  # Handle each event returned from the stream","                chunk = event.get(\"chunk\")","                if chunk:","                    chunk_json = json.loads(chunk.get(\"bytes\").decode())","                    if chunk_json is not None:","                        chunk_text = streaming_callback(chunk_json)","                        complete_response += chunk_text","                        yield complete_response  # Yield the accumulated response so far","            return complete_response","    except Exception as e:","        print(e, \"Error occurred!\")","        return \"\"","","# Sidebar","with st.sidebar:","    st.title('Streamlit Chat')","    st.subheader('With DynamoDB Memory :brain:')","    st.button('Clear Screen', on_click=clear_screen)","    st.write(f\"Total Tokens: {st.session_state.token_count}\")","    ","if user_prompt := st.chat_input(\"What's Up?\"):","    st.session_state.messages.append({\"role\": \"user\", \"content\": user_prompt})","    st.session_state.token_count += count_tokens(user_prompt)","    ","    with st.chat_message(\"user\"):","        st.write(user_prompt)","    ","    # Prepare the conversation history for the model","    conversation_history = [","        {\"role\": msg[\"role\"], \"content\": [{\"type\": \"text\", \"text\": msg[\"content\"]}]}","        for msg in st.session_state.messages","    ]","    ","    with st.chat_message(\"assistant\"):  ","        placeholder = st.empty()","        full_response = ''","        # Get the response from the model with streaming","        for chunk in get_streaming_response(conversation_history, chunk_handler):","            full_response = chunk","            placeholder.markdown(full_response)","        ","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": full_response})","        st.session_state.token_count += count_tokens(full_response)","","# Display updated token count in the sidebar","with st.sidebar:","    st.write(f\"Total Tokens: {st.session_state.token_count}\")",""]}],[{"start":{"row":47,"column":30},"end":{"row":47,"column":34},"action":"remove","lines":["1000"],"id":27},{"start":{"row":47,"column":30},"end":{"row":47,"column":31},"action":"insert","lines":["1"]},{"start":{"row":47,"column":31},"end":{"row":47,"column":32},"action":"insert","lines":["0"]},{"start":{"row":47,"column":32},"end":{"row":47,"column":33},"action":"insert","lines":["0"]}],[{"start":{"row":77,"column":45},"end":{"row":77,"column":46},"action":"remove","lines":[":"],"id":28},{"start":{"row":77,"column":44},"end":{"row":77,"column":45},"action":"remove","lines":["n"]},{"start":{"row":77,"column":43},"end":{"row":77,"column":44},"action":"remove","lines":["i"]},{"start":{"row":77,"column":42},"end":{"row":77,"column":43},"action":"remove","lines":["a"]},{"start":{"row":77,"column":41},"end":{"row":77,"column":42},"action":"remove","lines":["r"]},{"start":{"row":77,"column":40},"end":{"row":77,"column":41},"action":"remove","lines":["b"]},{"start":{"row":77,"column":39},"end":{"row":77,"column":40},"action":"remove","lines":[":"]},{"start":{"row":77,"column":38},"end":{"row":77,"column":39},"action":"remove","lines":[" "]},{"start":{"row":77,"column":37},"end":{"row":77,"column":38},"action":"remove","lines":["y"]},{"start":{"row":77,"column":36},"end":{"row":77,"column":37},"action":"remove","lines":["r"]},{"start":{"row":77,"column":35},"end":{"row":77,"column":36},"action":"remove","lines":["o"]},{"start":{"row":77,"column":34},"end":{"row":77,"column":35},"action":"remove","lines":["m"]},{"start":{"row":77,"column":33},"end":{"row":77,"column":34},"action":"remove","lines":["e"]},{"start":{"row":77,"column":32},"end":{"row":77,"column":33},"action":"remove","lines":["M"]},{"start":{"row":77,"column":31},"end":{"row":77,"column":32},"action":"remove","lines":[" "]},{"start":{"row":77,"column":30},"end":{"row":77,"column":31},"action":"remove","lines":["B"]},{"start":{"row":77,"column":29},"end":{"row":77,"column":30},"action":"remove","lines":["D"]},{"start":{"row":77,"column":28},"end":{"row":77,"column":29},"action":"remove","lines":["o"]},{"start":{"row":77,"column":27},"end":{"row":77,"column":28},"action":"remove","lines":["m"]}],[{"start":{"row":77,"column":26},"end":{"row":77,"column":27},"action":"remove","lines":["a"],"id":29},{"start":{"row":77,"column":25},"end":{"row":77,"column":26},"action":"remove","lines":["n"]},{"start":{"row":77,"column":24},"end":{"row":77,"column":25},"action":"remove","lines":["y"]},{"start":{"row":77,"column":23},"end":{"row":77,"column":24},"action":"remove","lines":["D"]}],[{"start":{"row":77,"column":23},"end":{"row":77,"column":24},"action":"insert","lines":["K"],"id":30},{"start":{"row":77,"column":24},"end":{"row":77,"column":25},"action":"insert","lines":["n"]},{"start":{"row":77,"column":25},"end":{"row":77,"column":26},"action":"insert","lines":["o"]},{"start":{"row":77,"column":26},"end":{"row":77,"column":27},"action":"insert","lines":["w"]},{"start":{"row":77,"column":27},"end":{"row":77,"column":28},"action":"insert","lines":["l"]},{"start":{"row":77,"column":28},"end":{"row":77,"column":29},"action":"insert","lines":["e"]},{"start":{"row":77,"column":29},"end":{"row":77,"column":30},"action":"insert","lines":["d"]},{"start":{"row":77,"column":30},"end":{"row":77,"column":31},"action":"insert","lines":["g"]},{"start":{"row":77,"column":31},"end":{"row":77,"column":32},"action":"insert","lines":["e"]}],[{"start":{"row":77,"column":32},"end":{"row":77,"column":33},"action":"insert","lines":[" "],"id":31},{"start":{"row":77,"column":33},"end":{"row":77,"column":34},"action":"insert","lines":["B"]},{"start":{"row":77,"column":34},"end":{"row":77,"column":35},"action":"insert","lines":["a"]},{"start":{"row":77,"column":35},"end":{"row":77,"column":36},"action":"insert","lines":["s"]},{"start":{"row":77,"column":36},"end":{"row":77,"column":37},"action":"insert","lines":["e"]},{"start":{"row":77,"column":37},"end":{"row":77,"column":38},"action":"insert","lines":["d"]}],[{"start":{"row":77,"column":38},"end":{"row":77,"column":39},"action":"insert","lines":[" "],"id":32},{"start":{"row":77,"column":39},"end":{"row":77,"column":40},"action":"insert","lines":["]"]}],[{"start":{"row":77,"column":39},"end":{"row":77,"column":40},"action":"remove","lines":["]"],"id":33},{"start":{"row":77,"column":38},"end":{"row":77,"column":39},"action":"remove","lines":[" "]}],[{"start":{"row":77,"column":38},"end":{"row":77,"column":39},"action":"insert","lines":[" "],"id":34},{"start":{"row":77,"column":39},"end":{"row":77,"column":40},"action":"insert","lines":["R"]},{"start":{"row":77,"column":40},"end":{"row":77,"column":41},"action":"insert","lines":["A"]},{"start":{"row":77,"column":41},"end":{"row":77,"column":42},"action":"insert","lines":["G"]}],[{"start":{"row":81,"column":42},"end":{"row":81,"column":43},"action":"remove","lines":["?"],"id":35},{"start":{"row":81,"column":41},"end":{"row":81,"column":42},"action":"remove","lines":["p"]},{"start":{"row":81,"column":40},"end":{"row":81,"column":41},"action":"remove","lines":["U"]},{"start":{"row":81,"column":39},"end":{"row":81,"column":40},"action":"remove","lines":[" "]},{"start":{"row":81,"column":38},"end":{"row":81,"column":39},"action":"remove","lines":["s"]},{"start":{"row":81,"column":37},"end":{"row":81,"column":38},"action":"remove","lines":["'"]},{"start":{"row":81,"column":36},"end":{"row":81,"column":37},"action":"remove","lines":["t"]},{"start":{"row":81,"column":35},"end":{"row":81,"column":36},"action":"remove","lines":["a"]},{"start":{"row":81,"column":34},"end":{"row":81,"column":35},"action":"remove","lines":["h"]},{"start":{"row":81,"column":33},"end":{"row":81,"column":34},"action":"remove","lines":["W"]}],[{"start":{"row":81,"column":33},"end":{"row":81,"column":34},"action":"insert","lines":["A"],"id":36},{"start":{"row":81,"column":34},"end":{"row":81,"column":35},"action":"insert","lines":["s"]},{"start":{"row":81,"column":35},"end":{"row":81,"column":36},"action":"insert","lines":["k"]}],[{"start":{"row":81,"column":36},"end":{"row":81,"column":37},"action":"insert","lines":[" "],"id":37},{"start":{"row":81,"column":37},"end":{"row":81,"column":38},"action":"insert","lines":["s"]},{"start":{"row":81,"column":38},"end":{"row":81,"column":39},"action":"insert","lines":["o"]},{"start":{"row":81,"column":39},"end":{"row":81,"column":40},"action":"insert","lines":["m"]},{"start":{"row":81,"column":40},"end":{"row":81,"column":41},"action":"insert","lines":["e"]}],[{"start":{"row":81,"column":41},"end":{"row":81,"column":42},"action":"insert","lines":[" "],"id":38},{"start":{"row":81,"column":42},"end":{"row":81,"column":43},"action":"insert","lines":["K"]},{"start":{"row":81,"column":43},"end":{"row":81,"column":44},"action":"insert","lines":["e"]},{"start":{"row":81,"column":44},"end":{"row":81,"column":45},"action":"insert","lines":["y"]}],[{"start":{"row":81,"column":44},"end":{"row":81,"column":45},"action":"remove","lines":["y"],"id":39},{"start":{"row":81,"column":43},"end":{"row":81,"column":44},"action":"remove","lines":["e"]},{"start":{"row":81,"column":42},"end":{"row":81,"column":43},"action":"remove","lines":["K"]}],[{"start":{"row":81,"column":42},"end":{"row":81,"column":43},"action":"insert","lines":["a"],"id":40},{"start":{"row":81,"column":43},"end":{"row":81,"column":44},"action":"insert","lines":["b"]},{"start":{"row":81,"column":44},"end":{"row":81,"column":45},"action":"insert","lines":["o"]},{"start":{"row":81,"column":45},"end":{"row":81,"column":46},"action":"insert","lines":["u"]},{"start":{"row":81,"column":46},"end":{"row":81,"column":47},"action":"insert","lines":["t"]}],[{"start":{"row":81,"column":47},"end":{"row":81,"column":48},"action":"insert","lines":[" "],"id":41},{"start":{"row":81,"column":48},"end":{"row":81,"column":49},"action":"insert","lines":["s"]},{"start":{"row":81,"column":49},"end":{"row":81,"column":50},"action":"insert","lines":["o"]},{"start":{"row":81,"column":50},"end":{"row":81,"column":51},"action":"insert","lines":["m"]},{"start":{"row":81,"column":51},"end":{"row":81,"column":52},"action":"insert","lines":["e"]}],[{"start":{"row":81,"column":52},"end":{"row":81,"column":53},"action":"insert","lines":[" "],"id":42},{"start":{"row":81,"column":53},"end":{"row":81,"column":54},"action":"insert","lines":["k"]},{"start":{"row":81,"column":54},"end":{"row":81,"column":55},"action":"insert","lines":["e"]},{"start":{"row":81,"column":55},"end":{"row":81,"column":56},"action":"insert","lines":["y"]}],[{"start":{"row":81,"column":55},"end":{"row":81,"column":56},"action":"remove","lines":["y"],"id":43},{"start":{"row":81,"column":54},"end":{"row":81,"column":55},"action":"remove","lines":["e"]},{"start":{"row":81,"column":53},"end":{"row":81,"column":54},"action":"remove","lines":["k"]},{"start":{"row":81,"column":52},"end":{"row":81,"column":53},"action":"remove","lines":[" "]}],[{"start":{"row":81,"column":52},"end":{"row":81,"column":53},"action":"insert","lines":[" "],"id":44},{"start":{"row":81,"column":53},"end":{"row":81,"column":54},"action":"insert","lines":["a"]},{"start":{"row":81,"column":54},"end":{"row":81,"column":55},"action":"insert","lines":["n"]},{"start":{"row":81,"column":55},"end":{"row":81,"column":56},"action":"insert","lines":["y"]},{"start":{"row":81,"column":56},"end":{"row":81,"column":57},"action":"insert","lines":["t"]},{"start":{"row":81,"column":57},"end":{"row":81,"column":58},"action":"insert","lines":["h"]},{"start":{"row":81,"column":58},"end":{"row":81,"column":59},"action":"insert","lines":["i"]},{"start":{"row":81,"column":59},"end":{"row":81,"column":60},"action":"insert","lines":["n"]},{"start":{"row":81,"column":60},"end":{"row":81,"column":61},"action":"insert","lines":["g"]}],[{"start":{"row":81,"column":61},"end":{"row":81,"column":62},"action":"insert","lines":[" "],"id":45},{"start":{"row":81,"column":62},"end":{"row":81,"column":63},"action":"insert","lines":["a"]},{"start":{"row":81,"column":63},"end":{"row":81,"column":64},"action":"insert","lines":["b"]},{"start":{"row":81,"column":64},"end":{"row":81,"column":65},"action":"insert","lines":["o"]},{"start":{"row":81,"column":65},"end":{"row":81,"column":66},"action":"insert","lines":["u"]},{"start":{"row":81,"column":66},"end":{"row":81,"column":67},"action":"insert","lines":["t"]}],[{"start":{"row":81,"column":67},"end":{"row":81,"column":68},"action":"insert","lines":[" "],"id":46},{"start":{"row":81,"column":68},"end":{"row":81,"column":69},"action":"insert","lines":["i"]},{"start":{"row":81,"column":69},"end":{"row":81,"column":70},"action":"insert","lines":["o"]},{"start":{"row":81,"column":70},"end":{"row":81,"column":71},"action":"insert","lines":["s"]}],[{"start":{"row":81,"column":71},"end":{"row":81,"column":72},"action":"insert","lines":[" "],"id":47},{"start":{"row":81,"column":72},"end":{"row":81,"column":73},"action":"insert","lines":["1"]},{"start":{"row":81,"column":73},"end":{"row":81,"column":74},"action":"insert","lines":["7"]}]]},"ace":{"folds":[],"scrolltop":576,"scrollleft":0,"selection":{"start":{"row":87,"column":4},"end":{"row":87,"column":4},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":53,"state":"start","mode":"ace/mode/python"}},"timestamp":1717558161932,"hash":"ed6dcc852ded01b26f2e7ceb03abafd401faa3bb"}